<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>پنل مدیریت پیشرفته درخشان - نسخه بهبود یافته</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.rtl.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    /* استایل‌های اصلی (همانند قبل) */
    body {
      font-family: Vazir, Tahoma, sans-serif;
      background: #f9f9f9;
      direction: rtl;
      color: #222;
      margin: 0;
    }
    .container {
      max-width: 950px;
      margin: 40px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 18px #0002;
      padding: 34px 16px 30px 16px;
    }
    /* ... سایر استایل‌ها ... */

    /* استایل‌های جدید برای تب‌ها */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .tab-btn {
      padding: 10px 20px;
      background: #f1f1f1;
      border: none;
      border-radius: 5px 5px 0 0;
      margin-left: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .tab-btn.active {
      background: #00bfa5;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    /* استایل برای پیش‌نمایش */
    .preview-box {
      border: 1px dashed #00bfa5;
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    
    /* استایل برای راهنما */
    .help-text {
      font-size: 0.85rem;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div id="loginBox" class="login-box">
  <h2>ورود مدیر</h2>
  <label>رمز مدیریت:</label>
  <input id="adminPass" type="password" placeholder="رمز عبور">
  <label>توکن GitHub (محرمانه):</label>
  <input id="githubToken" type="password" placeholder="توکن گیت‌هاب">
  <button onclick="doLogin()">ورود</button>
  <div class="msg error" id="loginMsg"></div>
</div>

<div id="adminPanel" style="display:none;">
  <div class="container">
    <div class="row" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>پنل مدیریت سایت</h2>
      <button class="logout-btn" onclick="logout()">خروج</button>
    </div>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('siteTab')">اطلاعات سایت</button>
      <button class="tab-btn" onclick="showTab('galleryTab')">گالری</button>
      <button class="tab-btn" onclick="showTab('pricesTab')">قیمت‌ها</button>
      <button class="tab-btn" onclick="showTab('reviewsTab')">نظرات</button>
      <button class="tab-btn" onclick="showTab('postsTab')">پست‌ها</button>
      <button class="tab-btn" onclick="showTab('scriptsTab')">اسکریپت‌ها</button>
      <button class="tab-btn" onclick="showTab('feedbackTab')">پیام‌ها</button>
      <button class="tab-btn" onclick="showTab('uploadTab')">آپلود</button>
    </div>
    
    <div id="mainSections"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
  // مقادیر ثابت
  const CORRECT_PASS = "yourStrongAdminPass123";
  const owner = "YOUR_GITHUB_USERNAME";
  const repo = "YOUR_REPO_NAME";
  const file = "index.html";
  const postsPath = "posts/";
  const feedbacksFile = "feedbacks.json";
  const scriptsFile = "custom_scripts.json";

  // مکان‌های ممکن برای اسکریپت‌ها
  const places = [
    { val: 'after_header', txt: 'بعد از هدر' },
    { val: 'after_hero', txt: 'بعد از بخش قهرمان' },
    { val: 'after_prices', txt: 'بعد از قیمت‌ها' },
    { val: 'after_gallery', txt: 'بعد از گالری' },
    { val: 'after_importance', txt: 'بعد از اهمیت شستشو' },
    { val: 'after_reviews', txt: 'بعد از نظرات' },
    { val: 'footer', txt: 'قبل از فوتر' },
    { val: 'end_body', txt: 'انتهای صفحه' }
  ];

  // متغیرهای جهانی
  let htmlBase = '';
  let galleryData = [];
  let pricesData = [];
  let reviewsData = [];
  let customScripts = [];
  let quill;
  let activeTab = 'siteTab';

  // تابع نمایش تب
  function showTab(tabId) {
    // مخفی کردن همه تب‌ها
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // غیرفعال کردن همه دکمه‌های تب
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // فعال کردن تب انتخاب شده
    document.getElementById(tabId).classList.add('active');
    
    // فعال کردن دکمه مربوطه
    document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
    
    activeTab = tabId;
  }

  // تابع برای هش SHA256
  function sha256(str) {
    return CryptoJS.SHA256(str).toString();
  }

  // توابع رمزگذاری و رمزگشایی
  function b64EncodeUnicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) =>
      String.fromCharCode('0x' + p1)
    ));
  }

  function b64DecodeUnicode(str) {
    return decodeURIComponent(Array.prototype.map.call(atob(str), c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
  }

  // تابع ورود به سیستم
  function doLogin() {
    const pass = document.getElementById("adminPass").value.trim();
    const token = document.getElementById("githubToken").value.trim();
    
    // محدودیت تعداد تلاش
    let loginAttempts = parseInt(localStorage.getItem("login_attempts") || "0");
    if (loginAttempts >= 3) {
      document.getElementById('loginMsg').innerText = "تعداد تلاش‌های شما بیش از حد مجاز است. لطفاً بعداً تلاش کنید.";
      return;
    }
    
    if (pass !== CORRECT_PASS) {
      loginAttempts++;
      localStorage.setItem("login_attempts", loginAttempts.toString());
      document.getElementById('loginMsg').innerText = `رمز اشتباه است. ${3 - loginAttempts} تلاش باقی مانده.`;
      return;
    }
    
    if (!token || token.length < 30) {
      document.getElementById('loginMsg').innerText = "توکن گیت‌هاب معتبر وارد کنید.";
      return;
    }
    
    // ریست کردن تعداد تلاش‌ها
    localStorage.removeItem("login_attempts");
    localStorage.setItem("d_admin", sha256(pass));
    sessionStorage.setItem("github_token", token);
    location.reload();
  }

  // تابع خروج از سیستم
  function logout() {
    localStorage.removeItem("d_admin");
    sessionStorage.removeItem("github_token");
    location.reload();
  }

  // بررسی وضعیت ورود
  function checkLogin() {
    const p = localStorage.getItem("d_admin");
    if (p === sha256(CORRECT_PASS)) {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      initAll();
    } else {
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
    }
  }

  // مقداردهی اولیه پنل
  function initAll() {
    document.getElementById('mainSections').innerHTML = `
      <div id="siteTab" class="tab-content active">
        <div id="siteEdit" class="section"></div>
      </div>
      <div id="galleryTab" class="tab-content">
        <div id="galleryEdit" class="section"></div>
      </div>
      <div id="pricesTab" class="tab-content">
        <div id="pricesEdit" class="section"></div>
      </div>
      <div id="reviewsTab" class="tab-content">
        <div id="reviewsEdit" class="section"></div>
      </div>
      <div id="scriptsTab" class="tab-content">
        <div id="customScriptsSection" class="section"></div>
      </div>
      <div id="postsTab" class="tab-content">
        <div id="postsSection" class="section"></div>
      </div>
      <div id="uploadTab" class="tab-content">
        <div id="imgUploadSection" class="section"></div>
      </div>
      <div id="feedbackTab" class="tab-content">
        <div id="feedbackSection" class="section"></div>
      </div>
    `;
    
    renderSiteEdit();
    renderGalleryEdit();
    renderPricesEdit();
    renderReviewsEdit();
    renderCustomScripts();
    renderPostsSection();
    renderImgUpload();
    renderFeedbackSection();
    
    // بارگذاری داده‌های اولیه
    fetchCurrent();
  }

  // بارگذاری اطلاعات سایت
  function fetchCurrent() {
    const token = sessionStorage.getItem("github_token");
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        htmlBase = b64DecodeUnicode(data.content.replace(/\n/g, ''));
        document.getElementById('siteTitle').value = htmlBase.match(/<title>(.*?)<\/title>/)?.[1] || "";
        document.getElementById('heroTitle').value = htmlBase.match(/<section class="hero">[\s\S]*?<h2>(.*?)<\/h2>/)?.[1] || "";
        document.getElementById('heroDesc').value = htmlBase.match(/<section class="hero">[\s\S]*?<p>(.*?)<\/p>/)?.[1] || "";
        document.getElementById('importance').value = htmlBase.match(/<section id="importance">[\s\S]*?<div class="importance-scroll">(.*?)<\/div>/)?.[1]?.replace(/<br>/g, "\n") || "";
        document.getElementById('contact').value = htmlBase.match(/<section id="contact">[\s\S]*?<div class="container contact-container">[\s\S]*?<div>([\s\S]*?)<\/div>/)?.[1] || "";
        
        // بارگذاری داده‌های دیگر
        loadGallery();
        loadPrices();
        loadReviews();
      });
  }

  // سایر توابع (همانند قبل) با بهبودهای جزئی
  // ...

  // تابع اصلی برای ذخیره تغییرات سایت
  function updateSite() {
    const token = sessionStorage.getItem("github_token");
    if (!token) { alert("ورود مجدد انجام دهید"); return; }
    
    document.getElementById('msgSite').innerHTML = 'در حال بروزرسانی...';
    
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        let newHtml = htmlBase
          .replace(/<title>.*?<\/title>/, `<title>${document.getElementById('siteTitle').value}</title>`)
          .replace(/(<section class="hero">[\s\S]*?<h2>)(.*?)(<\/h2>)/, `$1${document.getElementById('heroTitle').value}$3`)
          .replace(/(<section class="hero">[\s\S]*?<p>)(.*?)(<\/p>)/, `$1${document.getElementById('heroDesc').value}$3`)
          .replace(/<div class="importance-scroll">[\s\S]*?<\/div>/, `<div class="importance-scroll">${document.getElementById('importance').value.replace(/\n/g, "<br>")}</div>`)
          .replace(/(<section id="contact">[\s\S]*?<div class="container contact-container">[\s\S]*?<div>)[\s\S]*?(<\/div>)/, `$1${document.getElementById('contact').value}$2`);
        
        const encoded = b64EncodeUnicode(newHtml);
        
        return fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
          method: 'PUT',
          headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'بروزرسانی سایت',
            content: encoded,
            sha: data.sha
          })
        });
      })
      .then(res => res.json())
      .then(res => {
        if (res.content) {
          document.getElementById('msgSite').innerHTML = '<span style="color:green">✅ با موفقیت ثبت شد.</span>';
          // به‌روزرسانی htmlBase برای تغییرات بعدی
          htmlBase = b64DecodeUnicode(encoded);
        } else {
          document.getElementById('msgSite').innerHTML = '<span style="color:red">خطا در ثبت تغییرات!</span>';
        }
      })
      .catch(error => {
        document.getElementById('msgSite').innerHTML = `<span style="color:red">خطا: ${error.message}</span>`;
      });
  }

  // سایر توابع مدیریت محتوا (گالری، قیمت‌ها، نظرات و...) مانند قبل

  // تابع جدید برای نمایش پیش‌نمایش
  function showPreview(type) {
    // پیاده‌سازی پیش‌نمایش بر اساس نوع محتوا
    // این بخش می‌تواند بر اساس نیاز توسعه داده شود
    alert('امکان پیش‌نمایش در این نسخه اضافه خواهد شد.');
  }

  // بررسی وضعیت ورود هنگام بارگذاری صفحه
  checkLogin();
</script>
</body>
</html>