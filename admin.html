<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>پنل مدیریت پیشرفته درخشان</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.rtl.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      font-family: Vazir, Tahoma, sans-serif;
      background: #f9f9f9;
      direction: rtl;
      color: #222;
      margin: 0;
    }
    .container {
      max-width: 950px;
      margin: 40px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 18px #0002;
      padding: 34px 16px 30px 16px;
    }
    h2 {
      color: #00bfa5;
      margin-bottom: 14px;
      font-weight: bold;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 7px;
      border: 1px solid #bbb;
      font-family: inherit;
      font-size: 1rem;
      background: #fafafa;
      box-sizing: border-box;
      margin-bottom: 6px;
      resize: vertical;
    }
    button {
      padding: 8px 14px;
      font-size: 0.9rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #00bfa5;
      color: #fff;
      margin: 4px 2px;
    }
    button:hover {
      background: #008e76;
    }
    .del-btn {
      background: #e53935;
    }
    .del-btn:hover {
      background: #ba1a1a;
    }
    .edit-btn, .up-btn, .down-btn, .reply-btn {
      background: #fff1e3;
      color: #b34c00;
      border: 1px solid #ffbf7d;
    }
    .edit-btn:hover, .up-btn:hover, .down-btn:hover, .reply-btn:hover {
      background: #ffbf7d;
    }
    ul {
      margin: 0 0 7px 0;
      padding: 0;
      list-style: none;
    }
    li {
      margin-bottom: 7px;
    }
    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .msg {
      margin: 14px 0 0 0;
    }
    .error {
      color: #d32f2f;
    }
    .logout-btn {
      background: #ff5252;
      color: #fff;
    }
    .section {
      margin-bottom: 30px;
    }
    .ql-editor, .ql-toolbar {
      direction: rtl;
      text-align: right;
    }
    .posts-list {
      margin-top: 12px;
    }
    .post-item {
      background: #f5f5f5;
      padding: 6px 10px;
      border-radius: 7px;
      margin: 4px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .post-item-title {
      flex: 1;
      font-weight: bold;
    }
    .replybox {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 7px;
    }
    .login-box {
      max-width: 400px;
      margin: 100px auto;
      background: #fff;
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 2px 16px #0002;
    }
  </style>
</head>
<body>

<div id="loginBox" class="login-box">
  <h2>ورود مدیر</h2>
  <label>رمز مدیریت:</label>
  <input id="adminPass" type="password" placeholder="رمز عبور">
  <label>توکن GitHub (محرمانه):</label>
  <input id="githubToken" type="password" placeholder="توکن گیت‌هاب">
  <button onclick="doLogin()">ورود</button>
  <div class="msg error" id="loginMsg"></div>
</div>

<div id="adminPanel" style="display:none;">
  <div class="container">
    <div class="row" style="display:flex;justify-content:space-between;align-items:center;">
      <h2>پنل مدیریت سایت</h2>
      <button class="logout-btn" onclick="logout()">خروج</button>
    </div>
    <div id="mainSections"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
  const CORRECT_PASS = "yourStrongAdminPass123";
  const owner = "YOUR_GITHUB_USERNAME";
  const repo = "YOUR_REPO_NAME";
  const file = "index.html";
  const postsPath = "posts/";
  const feedbacksFile = "feedbacks.json";
  const scriptsFile = "custom_scripts.json";

  const places = [
    { val: 'after_header', txt: 'بعد از هدر' },
    { val: 'after_hero', txt: 'بعد از بخش قهرمان' },
    { val: 'after_prices', txt: 'بعد از قیمت‌ها' },
    { val: 'after_gallery', txt: 'بعد از گالری' },
    { val: 'after_importance', txt: 'بعد از اهمیت شستشو' },
    { val: 'after_reviews', txt: 'بعد از نظرات' },
    { val: 'footer', txt: 'قبل از فوتر' },
    { val: 'end_body', txt: 'انتهای صفحه' }
  ];

  function sha256(str) {
    return CryptoJS.SHA256(str).toString();
  }

  function b64EncodeUnicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) =>
      String.fromCharCode('0x' + p1)
    ));
  }

  function b64DecodeUnicode(str) {
    return decodeURIComponent(Array.prototype.map.call(atob(str), c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
  }

  function doLogin() {
    const pass = document.getElementById("adminPass").value.trim();
    const token = document.getElementById("githubToken").value.trim();
    if (pass !== CORRECT_PASS) {
      document.getElementById('loginMsg').innerText = "رمز اشتباه است.";
      return;
    }
    if (!token || token.length < 30) {
      document.getElementById('loginMsg').innerText = "توکن گیت‌هاب معتبر وارد کنید.";
      return;
    }
    localStorage.setItem("d_admin", sha256(pass));
    sessionStorage.setItem("github_token", token);
    location.reload();
  }

  function logout() {
    localStorage.removeItem("d_admin");
    sessionStorage.removeItem("github_token");
    location.reload();
  }

  function checkLogin() {
    const p = localStorage.getItem("d_admin");
    if (p === sha256(CORRECT_PASS)) {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      initAll();
    } else {
      document.getElementById('loginBox').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
    }
  }

  function initAll() {
    document.getElementById('mainSections').innerHTML = `
      <div id="siteEdit" class="section"></div>
      <div id="galleryEdit" class="section"></div>
      <div id="pricesEdit" class="section"></div>
      <div id="reviewsEdit" class="section"></div>
      <div id="customScriptsSection" class="section"></div>
      <div id="postsSection" class="section"></div>
      <div id="imgUploadSection" class="section"></div>
      <div id="feedbackSection" class="section"></div>
    `;
    renderSiteEdit();
    renderGalleryEdit();
    renderPricesEdit();
    renderReviewsEdit();
    renderCustomScripts();
    renderPostsSection();
    renderImgUpload();
    renderFeedbackSection();
  }

  let htmlBase = '';

  function renderSiteEdit() {
    document.getElementById('siteEdit').innerHTML = `
      <h3>ویرایش اطلاعات سایت</h3>
      <label>عنوان سایت:</label>
      <input id="siteTitle">
      <label>شعار اصلی (هدر):</label>
      <input id="heroTitle">
      <label>توضیح هدر:</label>
      <input id="heroDesc">
      <label>توضیح اهمیت شستشو:</label>
      <textarea id="importance" rows="4"></textarea>
      <label>اطلاعات تماس (HTML مجاز):</label>
      <textarea id="contact" rows="4"></textarea>
      <button onclick="updateSite()">ثبت و بروزرسانی سایت</button>
      <div class="msg" id="msgSite"></div>
    `;
    fetchCurrent();
  }

  function fetchCurrent() {
    const token = sessionStorage.getItem("github_token");
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        htmlBase = b64DecodeUnicode(data.content.replace(/\n/g, ''));
        document.getElementById('siteTitle').value = htmlBase.match(/<title>(.*?)<\/title>/)?.[1] || "";
        document.getElementById('heroTitle').value = htmlBase.match(/<section class="hero">[\s\S]*?<h2>(.*?)<\/h2>/)?.[1] || "";
        document.getElementById('heroDesc').value = htmlBase.match(/<section class="hero">[\s\S]*?<p>(.*?)<\/p>/)?.[1] || "";
        document.getElementById('importance').value = htmlBase.match(/<section id="importance">[\s\S]*?<div class="importance-scroll">(.*?)<\/div>/)?.[1]?.replace(/<br>/g, "\n") || "";
        document.getElementById('contact').value = htmlBase.match(/<section id="contact">[\s\S]*?<div class="container contact-container">[\s\S]*?<div>([\s\S]*?)<\/div>/)?.[1] || "";
      });
  }

  function updateSite() {
    const token = sessionStorage.getItem("github_token");
    if (!token) { alert("ورود مجدد انجام دهید"); return; }
    document.getElementById('msgSite').innerHTML = 'در حال بروزرسانی...';
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        let newHtml = htmlBase
          .replace(/<title>.*?<\/title>/, `<title>${document.getElementById('siteTitle').value}</title>`)
          .replace(/(<section class="hero">[\s\S]*?<h2>)(.*?)(<\/h2>)/, `$1${document.getElementById('heroTitle').value}$3`)
          .replace(/(<section class="hero">[\s\S]*?<p>)(.*?)(<\/p>)/, `$1${document.getElementById('heroDesc').value}$3`)
          .replace(/<div class="importance-scroll">[\s\S]*?<\/div>/, `<div class="importance-scroll">${document.getElementById('importance').value.replace(/\n/g, "<br>")}</div>`)
          .replace(/(<section id="contact">[\s\S]*?<div class="container contact-container">[\s\S]*?<div>)[\s\S]*?(<\/div>)/, `$1${document.getElementById('contact').value}$2`);
        const encoded = b64EncodeUnicode(newHtml);
        return fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
          method: 'PUT',
          headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'بروزرسانی سایت',
            content: encoded,
            sha: data.sha
          })
        });
      })
      .then(res => res.json())
      .then(res => {
        if (res.content) {
          document.getElementById('msgSite').innerHTML = '<span style="color:green">✅ با موفقیت ثبت شد.</span>';
        } else {
          document.getElementById('msgSite').innerHTML = '<span style="color:red">خطا در ثبت تغییرات!</span>';
        }
      });
  }

  let galleryData = [];
  function renderGalleryEdit() {
    document.getElementById('galleryEdit').innerHTML = `
      <h3>مدیریت گالری</h3>
      <ul id="galleryList"></ul>
      <button class="mini-btn" onclick="addGalleryItem()">افزودن عکس جدید</button>
    `;
    loadGallery();
  }

  function loadGallery() {
    const m = htmlBase.match(/<div class="gallery-grid">([\s\S]*?)<\/div>/);
    if (!m) { galleryData = []; renderGalleryList(); return; }
    galleryData = [...m[1].matchAll(/<img src="(.*?)"/g)].map(x => ({ url: x[1] }));
    renderGalleryList();
  }

  function renderGalleryList() {
    const ul = document.getElementById('galleryList');
    ul.innerHTML = '';
    galleryData.forEach((item, i) => {
      ul.innerHTML += `
        <li class="flex">
          <img class="gallery-thumb" src="${item.url}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
          <input value="${item.url}" onchange="editGallery(${i},this.value)" placeholder="آدرس تصویر">
          <button class="del-btn" onclick="removeGallery(${i})">حذف</button>
          <button class="up-btn" onclick="moveGallery(${i},-1)">↑</button>
          <button class="down-btn" onclick="moveGallery(${i},1)">↓</button>
        </li>`;
    });
  }

  function addGalleryItem() { galleryData.push({ url: '' }); renderGalleryList(); }
  function editGallery(i, val) { galleryData[i].url = val; }
  function removeGallery(i) { galleryData.splice(i, 1); renderGalleryList(); }
  function moveGallery(i, dir) {
    if (i + dir < 0 || i + dir >= galleryData.length) return;
    [galleryData[i], galleryData[i + dir]] = [galleryData[i + dir], galleryData[i]];
    renderGalleryList();
  }

  let pricesData = [];
  function renderPricesEdit() {
    document.getElementById('pricesEdit').innerHTML = `
      <h3>مدیریت قیمت‌ها</h3>
      <ul id="pricesList"></ul>
      <button class="mini-btn" onclick="addPriceItem()">افزودن قیمت جدید</button>
    `;
    loadPrices();
  }

  function loadPrices() {
    const m = htmlBase.match(/<div class="price-list">([\s\S]*?)<\/div>/);
    if (!m) { pricesData = []; renderPricesList(); return; }
    pricesData = [...m[1].matchAll(/<div class="price-item"><span>(.*?)<\/span><span><span class="original">(.*?)<\/span> → <span class="final">(.*?)<\/span><\/span><\/div>/g)]
      .map(x => ({ title: x[1], old: x[2], new: x[3] }));
    renderPricesList();
  }

  function renderPricesList() {
    const ul = document.getElementById('pricesList');
    ul.innerHTML = '';
    pricesData.forEach((item, i) => {
      ul.innerHTML += `
        <li class="flex">
          <input style="width:40%;" value="${item.title}" onchange="editPrice(${i},'title',this.value)" placeholder="عنوان">
          <input style="width:20%;" value="${item.old}" onchange="editPrice(${i},'old',this.value)" placeholder="قیمت قبل">
          <input style="width:20%;" value="${item.new}" onchange="editPrice(${i},'new',this.value)" placeholder="قیمت بعد">
          <button class="del-btn" onclick="removePrice(${i})">حذف</button>
          <button class="up-btn" onclick="movePrice(${i},-1)">↑</button>
          <button class="down-btn" onclick="movePrice(${i},1)">↓</button>
        </li>`;
    });
  }

  function addPriceItem() { pricesData.push({ title: '', old: '', new: '' }); renderPricesList(); }
  function editPrice(i, field, val) { pricesData[i][field] = val; }
  function removePrice(i) { pricesData.splice(i, 1); renderPricesList(); }
  function movePrice(i, dir) {
    if (i + dir < 0 || i + dir >= pricesData.length) return;
    [pricesData[i], pricesData[i + dir]] = [pricesData[i + dir], pricesData[i]];
    renderPricesList();
  }

  let reviewsData = [];
  function renderReviewsEdit() {
    document.getElementById('reviewsEdit').innerHTML = `
      <h3>مدیریت نظرات مشتریان</h3>
      <ul id="reviewsList"></ul>
      <button class="mini-btn" onclick="addReviewItem()">افزودن نظر جدید</button>
    `;
    loadReviews();
  }

  function loadReviews() {
    const m = htmlBase.match(/<div class="testimonial-grid">([\s\S]*?)<\/div>/);
    if (!m) { reviewsData = []; renderReviewsList(); return; }
    reviewsData = [...m[1].matchAll(/<div class="testimonial-card">(.*?)<\/div>/g)].map(x => ({ txt: x[1] }));
    renderReviewsList();
  }

  function renderReviewsList() {
    const ul = document.getElementById('reviewsList');
    ul.innerHTML = '';
    reviewsData.forEach((item, i) => {
      ul.innerHTML += `
        <li class="flex">
          <textarea style="width:70%;" onchange="editReview(${i},this.value)">${item.txt}</textarea>
          <button class="del-btn" onclick="removeReview(${i})">حذف</button>
          <button class="up-btn" onclick="moveReview(${i},-1)">↑</button>
          <button class="down-btn" onclick="moveReview(${i},1)">↓</button>
        </li>`;
    });
  }

  function addReviewItem() { reviewsData.push({ txt: '' }); renderReviewsList(); }
  function editReview(i, val) { reviewsData[i].txt = val; }
  function removeReview(i) { reviewsData.splice(i, 1); renderReviewsList(); }
  function moveReview(i, dir) {
    if (i + dir < 0 || i + dir >= reviewsData.length) return;
    [reviewsData[i], reviewsData[i + dir]] = [reviewsData[i + dir], reviewsData[i]];
    renderReviewsList();
  }

  let customScripts = [];
  function renderCustomScripts() {
    document.getElementById('customScriptsSection').innerHTML = `
      <h3>درج کد یا اسکریپت دلخواه</h3>
      <ul id="scriptsList"></ul>
      <button class="mini-btn" onclick="addScriptItem()">افزودن اسکریپت جدید</button>
    `;
    loadScripts();
  }

  function loadScripts() {
    const token = sessionStorage.getItem("github_token");
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${scriptsFile}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        if (data && data.content) {
          customScripts = JSON.parse(b64DecodeUnicode(data.content));
        } else {
          customScripts = [];
        }
        renderScriptsList();
      })
      .catch(() => {
        customScripts = [];
        renderScriptsList();
      });
  }

  function renderScriptsList() {
    const ul = document.getElementById('scriptsList');
    ul.innerHTML = '';
    customScripts.forEach((item, i) => {
      ul.innerHTML += `
        <li class="flex">
          <input style="width:20%;" value="${item.name}" onchange="editScript(${i},'name',this.value)" placeholder="نام دلخواه">
          <select style="width:20%;" onchange="editScript(${i},'place',this.value)">
            ${places.map(p => `<option value="${p.val}"${item.place == p.val ? ' selected' : ''}>${p.txt}</option>`).join('')}
          </select>
          <textarea style="width:50%;" onchange="editScript(${i},'code',this.value)" placeholder="کد دلخواه">${item.code || ''}</textarea>
          <button class="del-btn" onclick="removeScript(${i})">حذف</button>
        </li>`;
    });
  }

  function addScriptItem() {
    customScripts.push({ name: '', place: 'after_header', code: '' });
    renderScriptsList();
  }

  function editScript(i, field, val) {
    customScripts[i][field] = val;
  }

  function removeScript(i) {
    customScripts.splice(i, 1);
    renderScriptsList();
  }

  let quill;
  function renderPostsSection() {
    document.getElementById('postsSection').innerHTML = `
      <h3>پست‌های سایت</h3>
      <label>عنوان پست:</label>
      <input id="postTitle" placeholder="عنوان پست">
      <label>محتوای پست با ویرایشگر پیش‌رفته:</label>
      <div id="postEditor" style="height:200px;"></div>
      <button onclick="savePost()">ذخیره پست جدید</button>
      <div class="msg" id="postMsg"></div>
      <h4>لیست پست‌ها:</h4>
      <div class="posts-list" id="postsList"></div>
    `;
    setTimeout(() => {
      if (document.getElementById('postEditor')) {
        quill = new Quill('#postEditor', {
          theme: 'snow',
          placeholder: 'متن، عکس، لینک و هرچیز دیگر...',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              [{ 'list': 'ordered' }, { 'list': 'bullet' }],
              ['link', 'image'],
              [{ 'align': [] }],
              ['clean']
            ]
          }
        });
      }
    }, 200);
    fetchPosts();
  }

  function savePost() {
    const token = sessionStorage.getItem("github_token");
    const title = document.getElementById('postTitle').value.trim();
    const content = quill.root.innerHTML;
    if (!title || !content) {
      document.getElementById('postMsg').innerHTML = '<span class="error">لطفاً عنوان و محتوا را وارد کنید.</span>';
      return;
    }
    const slug = 'post-' + Date.now();
    const html = `<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>${title}</title>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
  <style>
    body{font-family:Vazir,Tahoma,sans-serif;max-width:780px;margin:30px auto 0 auto;background:#fafafa;padding:20px;line-height:1.8em}
    img{max-width:100%;border-radius:10px;margin:8px 0;}a{color:#039be5;}
  </style>
</head>
<body>
  <h1>${title}</h1>
  <hr>
  ${content}
</body>
</html>`;
    document.getElementById('postMsg').innerHTML = 'در حال ذخیره...';
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}${slug}.html`, {
      method: 'PUT',
      headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: `ایجاد پست ${title}`,
        content: b64EncodeUnicode(html)
      })
    })
      .then(res => res.json())
      .then(res => {
        if (res.content) {
          document.getElementById('postMsg').innerHTML = '<span style="color:green">✅ پست ذخیره شد.</span>';
          document.getElementById('postTitle').value = '';
          quill.setContents([]);
          fetchPosts();
        } else {
          document.getElementById('postMsg').innerHTML = '<span style="color:red">خطا در ذخیره پست!</span>';
        }
      });
  }

  function fetchPosts() {
    const token = sessionStorage.getItem("github_token");
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(list => {
        let out = '';
        if (Array.isArray(list)) {
          list.forEach(item => {
            if (item.name.endsWith('.html')) {
              const title = item.name.replace('.html', '');
              out += `<div class="post-item">
                        <span class="post-item-title">${title}</span>
                        <a target="_blank" href="posts/${item.name}">مشاهده</a>
                        <button class="del-btn" onclick="deletePost('${item.name}')">حذف</button>
                      </div>`;
            }
          });
        }
        document.getElementById('postsList').innerHTML = out || '<span>هیچ پستی هنوز ثبت نشده.</span>';
      });
  }

  function deletePost(fname) {
    const token = sessionStorage.getItem("github_token");
    if (!confirm("آیا مطمئنید؟")) return;
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}${fname}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}${fname}`, {
          method: 'DELETE',
          headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `حذف پست ${fname}`,
            sha: data.sha
          })
        })
          .then(() => fetchPosts());
      });
  }

  function renderImgUpload() {
    document.getElementById('imgUploadSection').innerHTML = `
      <h3>آپلود عکس</h3>
      <input type="file" id="imgUpload" accept="image/*">
      <button onclick="uploadImagePostimages()">آپلود و دریافت لینک</button>
      <input type="text" id="imgUrl" readonly style="margin-top:10px">
      <div class="msg" id="imgUploadMsg"></div>
    `;
  }

  function uploadImagePostimages() {
    const file = document.getElementById('imgUpload').files[0];
    if (!file) return alert('عکسی انتخاب نشده!');
    const data = new FormData();
    data.append('image', file);
    fetch('https://api.imgbb.com/1/upload?key=4e7e798c3e9e1b2', {
      method: 'POST',
      body: data
    })
      .then(res => res.json())
      .then(res => {
        if (res.data && res.data.url) {
          document.getElementById('imgUrl').value = res.data.url;
          document.getElementById('imgUploadMsg').innerHTML = 'لینک مستقیم: <span class="codeblock">' + res.data.url + '</span>';
        }
      });
  }

  function renderFeedbackSection() {
    document.getElementById('feedbackSection').innerHTML = `
      <h3>پیام‌ها و درخواست‌های کاربران</h3>
      <div id="feedbackList"></div>
    `;
    fetchFeedbacks();
  }

  function fetchFeedbacks() {
    const token = sessionStorage.getItem("github_token");
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${feedbacksFile}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        let arr = [];
        if (data && data.content) arr = JSON.parse(b64DecodeUnicode(data.content));
        renderFeedbackList(arr, data.sha);
      })
      .catch(() => renderFeedbackList([], null));
  }

  function renderFeedbackList(arr, sha) {
    const d = document.getElementById('feedbackList');
    if (!arr.length) { d.innerHTML = '<span>پیامی ثبت نشده.</span>'; return; }
    d.innerHTML = arr.map((msg, i) => `
      <div style="margin:8px 0;padding:10px;background:#f9f9f9;border-radius:8px;">
        <strong>${msg.name}</strong> (${msg.email})<br>
        ${msg.message}<br>
        <small>${msg.date}</small>
        <div class="replybox">
          <label>پاسخ ادمین:</label>
          <textarea onchange="replyToFeedback(${i},this.value)">${msg.reply || ''}</textarea>
        </div>
        <button class="del-btn" onclick="deleteFeedback(${i},'${sha}')">حذف</button>
      </div>
    `).join('');
  }

  function replyToFeedback(idx, reply) {
    const token = sessionStorage.getItem("github_token");
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${feedbacksFile}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        const arr = JSON.parse(b64DecodeUnicode(data.content));
        arr[idx].reply = reply;
        fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${feedbacksFile}`, {
          method: 'PUT',
          headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'پاسخ به پیام کاربر',
            content: b64EncodeUnicode(JSON.stringify(arr)),
            sha: data.sha
          })
        });
      });
  }

  function deleteFeedback(idx, sha) {
    const token = sessionStorage.getItem("github_token");
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${feedbacksFile}`, {
      headers: { Authorization: 'token ' + token }
    })
      .then(r => r.json())
      .then(data => {
        const arr = JSON.parse(b64DecodeUnicode(data.content));
        arr.splice(idx, 1);
        fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${feedbacksFile}`, {
          method: 'PUT',
          headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: 'حذف پیام کاربر',
            content: b64EncodeUnicode(JSON.stringify(arr)),
            sha: data.sha
          })
        })
          .then(() => fetchFeedbacks());
      });
  }

  checkLogin();
</script>
</body>
</html>