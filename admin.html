<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>پنل مدیریت پیشرفته درخشان</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnhttps://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.rtl.css" rel="stylesheet">
  <style>
    body{font-family:Vazir,Tahoma,sans-serif;background:#f9f9f9;direction:rtl;color:#222;margin:0;}
    .container{max-width:950px;margin:40px auto;background:#fff;border-radius:18px;box-shadow:0 2px 18px #0002;padding:34px 16px 30px 16px;}
    h2{color:#00bfa5;margin-bottom:14px;font0 7px 0;font-weight:bold;}
    input,textarea,select{
      width:100%;padding:8px 10px;border-radius:7px;border:1px solid #bbb;font-family:inherit;font-size:1rem;background:#fafafa;box-sizing:border-box;margin-bottom:6px;resize13px;border-radius:4px;}
    .del-btn{background:#e53935;}
    .del-btn:hover{background:#ba1a1a;}
    .edit-btn,.up-btn,.down-btn,.reply-btn{background:#fff1e3;color:#b34c00;border:1px solid #ffbf7d;}
    .edit-btn:hover,.up-btn:hover,.down-btn:hover,.reply-btn:hover{background:#ffbf7d;}
    ul{margin:0 0 7px 0;padding:0;list-style:none;}
    li{margin-bottom:7px;}
    .flex{display .msg{margin:14px 0 0 0;}
    .error{color:#d32f2f;}
    .logout-btn{background:#ff5252;color:#fff;}
    .row{display:flex;gap:20px;align-items:center;justify-content:space-between;}
    .ql-editor,.ql-toolbar{direction:rtl;text-align:right;}
    .posts-list{margin:12px 0;}
    .post-item{background:#f5f5f5;padding:6px 10px;border-radius:7px;margin:4px 0;display:flex;align-items:center;justify-content0 auto;background:#fff;padding:32px 22px;border-radius:14px;box-shadow:0 2px 16px #0002;}
    .replybox{background:#f5f5f5;padding:10px;border-radius:7px;}
    @media(max-width:950px){.container>
</head>
<body>
<div id="loginBox" class="login-box">
  <h2>ورود مدیر</h2>
  <label>رمز مدیریت:</label>
  <input id="adminPass" type="password" placeholder="رمز عبور">
  <label>توکن GitHub (محرمانه):</label>
  <input id="githubToken" type="password" placeholder="توکن گیت‌هاب">
  <button onclick="doLogin()">ورود</button>
  <div class="msg error" id="loginMsg"></div>
</div>
<div class="" onclick="logout()">خروج</button>
  </div>
  <div id="mainSections">
    <!-- بخش‌ها در اسکریپت به صورت پویا اضافه می‌شوند -->
  </div>
</div>
<!-- Quill Editor -->
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
const CORRECT_PASS = "yourStrongAdminPass123";
const owner = "rezawin8410-ux";
const repo = "mderakhshan.github.io";
const file = "index.html";
const postsPath = "posts/";
const feedbacksFile:'after_header',txt:'بعد از هدر'},
  {val:'after_hero',txt:'بعد از بخش قهرمان'},
  {val:'after_prices',txt:'بعد از قیمت‌ها'},
  {val:'after_gallery',txt:'بعد از گالری'},
  {val:'after_importance',txt:'بعد از اهمیت شستشو'},
  {val:'after_reviews',txt:'بعد از نظرات'},
  {val:'footer',txt:'قبل از فوتر'},
  {val:'end_body',txt:'انتهای صفحه'}
];

// --- Base64 فارسی ---
function b64EncodeUnicode(str) {
  returnCode('0x' + p1); }
  ));
}
function b64DecodeUnicode(str) {
  return decodeURIComponent(Array.prototype.map.call(atob(str), c=>{
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}
functionvalue.trim();
  let token = document.getElementById("githubToken").value.trim();
  if(pass!==CORRECT_PASS) {
    document.getElementById('loginMsg').innerText="رمز اشتباه است.";
    return;
  }
  if(!token||token.length<30) {
    document.getElementById('loginMsg').innerText="توکن گیت‌هاب معتبر وارد کنید.";
    return;
  }
  localStorage.setItem("d_admin", sha256(pass));
  sessionStorage.setItem("github_token", token);
  document.getElementById('loginBox').style.display='none';
Item("github_token");
  location.reload();
}
function checkLogin(){
  let p = localStorage.getItem("d_admin");
  if(p===sha256(CORRECT_PASS)){
    document.getElementById('loginBox').style.display='none';
    document.getElementById('adminPanel').style.display='block';
    initAll();
  }else{
    document.getElementById('loginBox').style.display='block';
    document.getElementById('adminPanel').style.display='none';
  }
}
checkLogin();

function initAll(){
  document.getElementById('mainSections').innerHTML = `
 ="galleryEdit"></div>
  <div id="pricesEdit"></div>
  <div id="reviewsEdit"></div>
  <div id="customScriptsSection"></div>
  <div id="postsSection"></div>
  <div id="imgUploadSection"></div>
  <div id="feedbackSection"></div>
  `;
  renderSiteEdit();
  renderGalleryEdit();
  renderPricesEdit();
  renderReviewsEdit();
  renderCustomScripts();
  renderPostsSection();
  renderImgUpload();
  renderFeedbackSection();
}

//////////////////// بخش 1: ویرایش سایت /////////////////////
function renderSiteEdit(){
  document>
    <input id="siteTitle">
    <label>شعار اصلی (هدر):</label>
    <input id="heroTitle">
    <label>توضیح هدر:</label>
    <input id="heroDesc">
    <label>توضیح اهمیت شستشو:</label>
    <textarea id="importance"></textarea>
    <label>اطلاعات تماس (HTML مجاز):</label>
    <textarea id="contact"></textarea>
    <button onclick="updateSite()">ثبت و بروزرسانی سایت</button>
    <div class="msg" id="msgSite"></div>
  </div>
  `;
  fetchCurrent();
}

Base='';
function fetchCurrent(){
  let token = sessionStorage.getItem("github_token");
  fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
    headers: { Authorization: 'token ' + token }
  })
  .then(r=>r.json())
  .then(data=>{
    htmlBase = b64DecodeUnicode(data.content.replace(/\n/g,''));
    document.getElementById('siteTitle').value = htmlBase.match(/<title>(.*?)<\/title>/)?.[1]||"";
    document.getElementById('heroTitle').value = htmlBase.match(/<section class="<section class="hero">[\s\S]*?<p>(.*?)<\/p>/)?.[1]||"";
    let importance = htmlBase.match(/<section id="importance">[\s\S]*?<div class="importance-scroll">(.*?)<\/div>/)?.[1]?.replace(/<br>/g,"\n")||"";
    document.getElementById('importance').value = importance;
    let contact = htmlBase.match(/<section id="contact">[\s\S]*?<div class="container contact-container">[\s\S]*?<div>([\s\S]*?)<\/div>/)?.[1]||"";
^\s+|\s+$/g,"");
    // سایر بخش‌ها در توابع خودشان لود می‌شوند
  });
}

function updateSite(){
  let token = sessionStorage.getItem("github_token");
  if(!token){alert("ورود مجدد انجام دهید");return;}
  document.getElementById('msgSite').innerHTML = 'در حال بروزرسانی...';
  fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
    headers: { Authorization: 'token ' + token }
  })
  .then(r=>r.json())
  .then(data=>{
    let<title>.*?<\/title>/, `<title>${document.getElementById('siteTitle').value}</title>`)
      .replace(/(<section class="hero">[\s\S]*?<h2>)(.*?)(<\/h2>)/, `$1${document.getElementById('heroTitle').value}$3`)
      .replace(/(<section class="hero">[\s\S]*?<p>)(.*?)(<\/p>)/, `$1${document.getElementById('heroDesc').value}$3`)
      .replace(/<div class="importance-scroll">[\s\S]*?<\/div(<section id="contact">[\s\S]*?<div class="container contact-container">[\s\S]*?<div>)[\s\S]*?(<\/div>)/, `$1${document.getElementById('contact').value}$2`);
    let encoded = b64EncodeUnicode(newHtml);
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file}`, {
      method: 'PUT',
      headers: { Authorization: 'token ' + token, 'Content-Type':'application/json' },
      body: JSON.stringify({
        message: 'بروزرسانی سایت',
        content: encoded,
       =>r.json())
    .then(res=>{
      if(res.content){
        document.getElementById('msgSite').innerHTML = '<span style="color:green">✅ با موفقیت ثبت شد.</span>';
      } else {
        document.getElementById('msgSite').innerHTML = '<span style="color:red">خطا در ثبت تغییرات!</span>';
      }
    });
  });
}

//////////////////// بخش 2: مدیریت گالری /////////////////////
let galleryData=[];
function renderGalleryEdit(){
  document.getElementById('galleryEdit').innerHTML = `
  <div class="section">
    <h3زودن عکس جدید</button>
  </div>`;
  loadGallery();
}
function loadGallery(){
  let m = htmlBase.match(/<div class="gallery-grid">([\s\S]*?)<\/div>/);
  if(!m){galleryData=[];renderGalleryList();return;}
  galleryData = [...m[1].matchAll(/<img src="(.*?)"/g)].map(x=>({url:x[1]}));
  renderGalleryList();
}
function renderGalleryList(){
  let ul = document.getElementById('galleryList');
  if(!ul) return;
  ul.innerHTML = '';
  gallery class="gallery-thumb" src="${item.url}"/>
      <input value="${item.url}" onchange="editGallery(${i},this.value)">
      <button class="del-btn" onclick="removeGallery(${i})">حذف</button>
      <button class="up-btn" onclick="moveGallery(${i},-1)">↑</button>
      <button class="down-btn" onclick="moveGallery(${i},1)">↓</button>
    </li>`;
  });
}
function addGalleryItem(){ galleryData.push({url:''}); renderGalleryList(); }
function editGallery(i,val){ galleryData[i].url=val return;
  [galleryData[i],galleryData[i+dir]] = [galleryData[i+dir],galleryData[i]];
  renderGalleryList();
}

//////////////////// بخش 3: مدیریت قیمت‌ها /////////////////////
let pricesData=[];
function renderPricesEdit(){
  document.getElementById('pricesEdit').innerHTML = `
  <div class="section">
    <h3>مدیریت قیمت‌ها</h3>
    <ul id="pricesList"></ul>
    <button class="mini-btn" onclick="addPriceItem()">افزودن قیمت جدید</button>
  </div>`;
  loadPrices();
}
functionm){pricesData=[];renderPricesList();return;}
  pricesData = [...m[1].matchAll(/<div class="price-item"><span>(.*?)<\/span><span><span class="original">(.*?)<\/span> → <span class="final">(.*?)<\/span><\/span><\/div>/g)]
    .map(x=>.title}" onchange="editPrice(${i},'title',this.value)">
      <input style="width:18%;" value="${item.old}" onchange="editPrice(${i},'old',this.value)">
      <input style="width:18%;" value="${item.new}" onchange="editPrice(${i},'new',this.value)">
      <button class="del-btn" onclick="removePrice(${i})">حذف</button>
      <button class="up-btn" onclick="movePrice(${i},-1)">↑</button>
      <button class="down-btn" onclick="movePrice(${i},1)">↓.push({title:'',old:'',new:''}); renderPricesList(); }
function editPrice(i,field,val){ pricesData[i][field]=val; }
function removePrice(i){ pricesData.splice(i,1); renderPricesList(); }
function movePrice(i,dir){
  if(i+dir<0||i+dir>=pricesData.length) return;
  [pricesData[i],pricesData[i+dir]] = [pricesData[i+dir],pricesData[i]];
  renderPricesList();
}

//////////////////// بخش 4: مدیریت نظرات /////////////////////
let reviewsData=[];
function renderReviewsEdit(){
  document.getElementBy="section">
    <h3>مدیریت نظرات مشتریان</h3>
    <ul id="reviewsList"></ul>
    <button class="mini-btn" onclick="addReviewItem()">افزودن نظر جدید</button>
  </div>`;
  loadReviews();
}
function loadReviews(){
  let m = htmlBase.match(/<div class="testimonial-grid">([\s\S]*?)<\/div>/);
  if(!m){reviewsData=[];renderReviewsList();return;}
  reviewsData = [...m[1].matchAll(/<div class="testimonial-card">(.*?)<\/div>/g)].map(x=>({txt:x[1]}));
  renderReviewsList();
}
function renderReviewsList(){
    ul.innerHTML += `<li class="flex">
      <input style="width:68%;" value="${item.txt}" onchange="editReview(${i},this.value)">
      <button class="del-btn" onclick="removeReview(${i})">حذف</button>
      <button class="up-btn" onclick="moveReview(${i},-1)">↑</button>
      <button class="down-btn" onclick="moveReview(${i},1)">↓</button>
    </li>`;
  });
}
function addReviewItem(){ reviewsData.push({txt:''}); renderReviewsList(); }
function editReview(i,val){ reviews }
function moveReview(i,dir){
  if(i+dir<0||i+dir>=reviewsData.length) return;
  [reviewsData[i],reviewsData[i+dir]] = [reviewsData[i+dir],reviewsData[i]];
  renderReviewsList();
}

//////////////////// بخش 5: اسکریپت/کد دلخواه /////////////////////
let customScripts = [];
function renderCustomScripts(){
  document.getElementById('customScriptsSection').innerHTML = `
  <div class="section">
    <h3>درج کد یا اسکریپت دلخواه</h3>
    <ul id=".getItem("github_token");
  fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${scriptsFile}`, {
    headers: { Authorization: 'token ' + token }
  })
  .then(r=>r.json()).then(data=>{
    if(data && data.content){
      customScripts = JSON.parse(b64DecodeUnicode(data.content));
    }else{
      customScripts=[];
    }
    renderScriptsList();
  }).catch(()=>{customScripts=[];renderScriptsList();});
}
function renderScriptsList(){
  let ul = document.getElementById('scriptsList');
  if(!ul) return;
  ul.innerHTML''}" onchange="editScript(${i},'name',this.value)" placeholder="نام دلخواه">
      <select class="code-place-select" onchange="editScript(${i},'place',this.value)">
        ${places.map(p=>`<option value="${p.val}"${item.place==p.val?' selected':''}>${p.txt}</option>`).join('')}
      </select>
      <textarea style="width:38%;" onchange="editScript(${i},'code',this.value)" placeholder="کد دلخواه">${item.code||''}</textarea>
      <button class="del-btn" onclick="removeScript(${(); }
function editScript(i,field,val){ customScripts[i][field]=val; }
function removeScript(i){ customScripts.splice(i,1); renderScriptsList(); }

//////////////////// بخش 6: مدیریت پست و آپلود عکس /////////////////////
function renderPostsSection(){
  document.getElementById('postsSection').innerHTML=`
  <div class="section">
    <h3>پست‌های سایت</h3>
    <label>عنوان پست:</label>
    <input id="postTitle" placeholder="عنوان پست">
    <label>محتوای پست با ویرایشگر پیشخیره پست جدید</button>
    <div class="msg" id="postMsg"></div>
    <h4>لیست پست‌ها:</h4>
    <div class="posts-list" id="postsList"></div>
  </div>`;
  setTimeout(()=>initQuill(),200); // صبر کن تا DOM ساخته شود
  fetchPosts();
}
let quill;
function initQuill(){
  if(document.getElementById('postEditor')){
    quill = new Quill('#postEditor', {
      theme: 'snow',
      placeholder: 'متن، عکس، لینک و هرچ'],
          [{'header':[1,2,3,false]}],
          [{'list':'ordered'},{'list':'bullet'}],
          ['link','image'],
          [{'align':[]}],
          ['clean']
        ]
      }
    });
  }
}
function savePost(){
  let token = sessionStorage.getItem("github_token");
  let title = document.getElementById('postTitle').value.trim();
  let content = quill.root.innerHTML;
  if(!title||!content||content==='') {
    document.getElementById('postMsg').innerHTML = '<span class="error">لطفاً عنوان و مح کنید.</span>';
    return;
  }
  let slug = 'post-' + Date.now();
  let html =
`<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>${title}</title>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
  <style>body{font-family:Vazir,Tahoma,sans-serif;max-width:780px;margin:30px auto 0 auto;background:#fafafa;%;border-radius:10px;margin:8px 0;}
    a{color:#039be5;}
  </style>
</head>
<body>
  <h1>${title}</h1>
  <hr>
  ${content}
</body>
</html>`;
  document.getElementById('postMsg').innerHTML = 'در حال ذخیره...';
  fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}${slug}.html`,{
    method:'PUT',
    headers:{Authorization:'token '+token,'Content-Type':'application/json'},
    body:JSON.stringify({
      message:`ایجادیت ذخیره شد.</span>';
      document.getElementById('postTitle').value = '';
      quill.setContents([]);
      fetchPosts();
    } else{
      document.getElementById('postMsg').innerHTML = '<span style="color:red">خطا در ذخیره پست!</span>';
    }
  });
}
function fetchPosts(){
  let token = sessionStorage.getItem("github_token");
  fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`,{
    headers:{Authorization:'token '+token}
  })
  .then(r=>r.json())
  .then(list=>{
    let title = item.name.replace('.html','');
          out += `<div class="post-item">
                    <span class="post-item-title">${title}</span>
                    <a target="_blank" href="posts/${item.name}">مشاهده</a>
                    <button class="del-btn" onclick="deletePost('${item.name}')">حذف</button>
                  </div>`;
        }
      });
      document.getElementById('postsList').innerHTML = out||'<span>هیچ پستی هنوز ثبت نشده.</span>';
    }
  });
}
function deletePost(fname){
  let token = sessionStorage.getItem("github_token");
  if(!confirm("آیا  })
  .then(r=>r.json())
  .then(data=>{
    fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}${fname}`,{
      method:'DELETE',
      headers:{Authorization:'token '+token,'Content-Type':'application/json'},
      body:JSON.stringify({
        message:`حذف پست ${fname}`,
        sha:data.sha
      })
    })
    .then(r=>r.json())
    .then(res=>{
      fetchPosts();
    });
  });
}

//////////////////// بخش 7: آپلود عکس با Postimages /////////////////////
function renderImgUpload(){
  document.getElementById('Postimages()">آپلود و دریافت لینک</button>
    <input type="text" id="imgUrl" readonly style="margin-top:10px">
    <div class="msg" id="imgUploadMsg"></div>
  </div>`;
}
function uploadImagePostimages() {
  let file = document.getElementById('imgUpload').files[0];
  if(!file) return alert('عکسی انتخاب نشده!');
  let data = new FormData();
  data.append('image', file);
  fetch('https://api.imgbb.com/1/upload?key=4e7e798c3e9e=>{
    if(res.data && res.data.url){
      document.getElementById('imgUrl').value = res.data.url;
      document.getElementById('imgUploadMsg').innerHTML = 'لینک مستقیم: <span class="codeblock">'+res.data.url+'</span>';
    }
  });
}

//////////////////// بخش 8: پیام کاربر و پاسخ ادمین /////////////////////
function renderFeedbackSection(){
  document.getElementById('feedbackSection').innerHTML=`
  <div class="section">
    <h3>پیام‌ها و درخواست‌های کاربران</h3>
    <div id="feedbackList"></token '+token}
  })
  .then(r=>r.json()).then(data=>{
    let arr=[];
    if(data && data.content) arr = JSON.parse(b64DecodeUnicode(data.content));
    renderFeedbackList(arr,data.sha);
  }).catch(()=>{renderFeedbackList([],null)});
}
function renderFeedbackList(arr,sha){
  let d = document.getElementById('feedbackList');
  if(!d) return;
  if(!arr.length){d.innerHTML='<span>پیامی ثبت نشده.</span>';return;}
  d.innerHTML = arr.map((msg,i)=>`
    <div style="margin:8px </a>':''}
      <div class="replybox">
        <label>پاسخ ادمین:</label>
        <textarea onchange="replyToFeedback(${i},this.value)">${msg.reply||''}</textarea>
      </div>
      <button class="del-btn" onclick="deleteFeedback(${iowner}/${repo}/contents/${feedbacksFile}`,{
      method:'PUT',
      headers:{Authorization:'token '+token,'Content-Type':'application/json'},
      body:JSON.stringify({
        message:'پاسخ به پیام کاربر',
        content:b64EncodeUnicode(JSON.stringify(arr)),
        sha:data.sha
      })
    });
  });
}
function deleteFeedback(idx,sha){
  let token = sessionStorage.getItem("github_token");
  fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${feedbacksFile}`,{
    headers:{Authorization:'token '+token}
  })
  .then(r=>r.json()).thentoken,'Content-Type':'application/json'},
      body:JSON.stringify({
        message:'حذف پیام کاربر',
        content:b64EncodeUnicode(JSON.stringify(arr)),
        sha:data.sha
      })
    })
    .then(()=>fetchFeedbacks());
  });
}

</script>
</body>
</html>